<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมคำนวณ Creatinine Clearance</title>
    <!-- ใช้ Tailwind CSS สำหรับตกแต่งหน้าตาให้สวยงามทันที -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ฟอนต์ภาษาไทย -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        .input-label {
            display: block;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
            transition: ring 0.2s;
        }
        .input-field:focus {
            ring: 2px solid #3b82f6;
            border-color: #3b82f6;
        }
        /* Animation สำหรับรูปไต */
        .kidney-icon {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen py-10 px-4">

    <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full">
        <!-- Header -->
        <div class="text-center mb-8">
            <!-- เปลี่ยนจากไอคอนเดิมเป็นรูปไต -->
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-blue-50 mb-4 shadow-sm">
                <img src="https://img.icons8.com/color/96/kidney.png" 
                     alt="Kidney Icon" 
                     class="w-12 h-12 kidney-icon"
                     onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/2867/2867456.png';">
            </div>
            <h1 class="text-2xl font-bold text-gray-800">คำนวณค่า CrCl</h1>
            <p class="text-gray-500 text-sm mt-1">งานบริบาลเภสัชกรรม ฝ่ายยาและเวชภัณฑ์</p>
            <p class="text-gray-500 text-sm mt-1">โรงพยาบาลสมเด็จพระบรมราชเทวี ณ ศรีราชา</p>
        </div>

        <!-- Form -->
        <form id="crclForm" class="space-y-4">
            
            <!-- เพศ (จำเป็นสำหรับสูตร) -->
            <div>
                <label class="input-label">เพศ (Gender)</label>
                <div class="flex gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="gender" value="male" checked class="text-blue-600 focus:ring-blue-500 h-4 w-4">
                        <span class="text-gray-700">ชาย</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="gender" value="female" class="text-pink-600 focus:ring-pink-500 h-4 w-4">
                        <span class="text-gray-700">หญิง</span>
                    </label>
                </div>
            </div>

            <!-- อายุ -->
            <div>
                <label for="age" class="input-label">อายุ (ปี)</label>
                <input type="number" id="age" required min="1" max="120" class="input-field" placeholder="ระบุอายุ">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- น้ำหนัก -->
                <div>
                    <label for="weight" class="input-label">น้ำหนัก (kg)</label>
                    <input type="number" id="weight" required step="0.1" min="1" class="input-field" placeholder="กก.">
                </div>
                <!-- ส่วนสูง -->
                <div>
                    <label for="height" class="input-label">ส่วนสูง (cm)</label>
                    <input type="number" id="height" required step="0.1" min="1" class="input-field" placeholder="ซม.">
                </div>
            </div>

            <!-- Serum Creatinine -->
            <div>
                <label for="scr" class="input-label">Serum Creatinine (mg/dL)</label>
                <input type="number" id="scr" required step="0.01" min="0.1" class="input-field" placeholder="ค่า Cr">
            </div>

            <!-- Buttons -->
            <div class="pt-4 flex gap-3">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                    คำนวณผล
                </button>
                <button type="button" onclick="resetForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                    ล้างค่า
                </button>
            </div>
        </form>

        <!-- Result Section (Hidden by default) -->
        <div id="resultSection" class="hidden mt-8 border-t pt-6 animate-fade-in">
            <h3 class="text-gray-500 text-sm font-semibold uppercase tracking-wider mb-2">ผลการคำนวณ</h3>
            
            <!-- Warning Message for Obesity -->
            <div id="obesityWarning" class="hidden mb-4 bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-orange-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-orange-700 font-medium">
                            พบภาวะโรคอ้วน (Obesity, BMI <span id="bmiValueDisplay"></span>)
                        </p>
                        <p class="text-xs text-orange-600 mt-1">
                            ระบบใช้ <span class="font-bold">Adjusted Body Weight (<span id="adjBwValue"></span> kg)</span> ในการคำนวณแทนน้ำหนักจริง
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- CrCl Result -->
                <div class="bg-blue-50 rounded-lg p-5 text-center border border-blue-100 relative">
                    <p class="text-gray-600 text-xs font-semibold uppercase mb-1">Cockcroft-Gault</p>
                    <p class="text-gray-800 text-sm mb-1 font-bold">Creatinine Clearance</p>
                    <div class="text-3xl font-bold text-blue-700 mb-2">
                        <span id="crclValue">0</span> <span class="text-lg text-blue-500 font-normal">ml/min</span>
                    </div>
                </div>

                <!-- eGFR Result (Added) -->
                <div class="bg-green-50 rounded-lg p-5 text-center border border-green-100 relative">
                    <p class="text-gray-600 text-xs font-semibold uppercase mb-1">CKD-EPI</p>
                    <p class="text-gray-800 text-sm mb-1 font-bold">eGFR</p>
                    <div class="text-3xl font-bold text-green-700 mb-2">
                        <span id="egfrValue">0</span> <span class="text-lg text-green-500 font-normal">ml/min/1.73m²</span>
                    </div>
                </div>
            </div>
            
            <!-- Interpretation Badge -->
            <div class="mt-6 text-center">
                <span id="interpretationBadge" class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-gray-200 text-gray-800">
                    รอผลการประเมิน
                </span>
                <p id="interpretationText" class="text-sm text-gray-600 mt-2"></p>
            </div>

            <div class="mt-4 text-xs text-gray-400 text-center">
                *หมายเหตุ: CrCl ในคนอ้วน BMI≥30 ใช้ Adjust Body weight<br>
                *eGFR ใช้สูตร CKD-EPI 2009 (สำหรับการแบ่งระยะโรคไต)
            </div>
        </div>
    </div>

    <script>
        document.getElementById('crclForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateCrCl();
        });

        function calculateCrCl() {
            // 1. รับค่าจากฟอร์ม
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const age = parseFloat(document.getElementById('age').value);
            const weight = parseFloat(document.getElementById('weight').value); // Actual Body Weight
            const height = parseFloat(document.getElementById('height').value); 
            const scr = parseFloat(document.getElementById('scr').value);

            // Validation เบื้องต้น
            if (!age || !weight || !scr || scr === 0 || !height) {
                alert("กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง (Cr ต้องไม่เป็น 0)");
                return;
            }

            // --- Logic ใหม่: ตรวจสอบ BMI และเลือกน้ำหนัก ---
            let weightToUse = weight;
            let isObese = false;
            let adjBW = 0;

            // คำนวณ BMI (kg/m^2)
            const heightInMeters = height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);

            // ถ้า BMI >= 30 ให้ใช้ Adjusted Body Weight
            if (bmi >= 30) {
                isObese = true;

                // 1. คำนวณ Ideal Body Weight (IBW) สูตร Devine
                // ชาย: 50 + 2.3 * (height in inches - 60)
                // หญิง: 45.5 + 2.3 * (height in inches - 60)
                const heightInInches = height / 2.54;
                const baseIBW = (gender === 'male') ? 50 : 45.5;
                let ibw = baseIBW + 2.3 * (heightInInches - 60);

                // 2. คำนวณ Adjusted Body Weight
                // AdjBW = IBW + 0.4 * (Actual Weight - IBW)
                adjBW = ibw + 0.4 * (weight - ibw);
                
                weightToUse = adjBW;
            }
            // ---------------------------------------------

            // 2. คำนวณ CrCl ตามสูตร Cockcroft-Gault
            let crcl = ((140 - age) * weightToUse) / (72 * scr);
            if (gender === 'female') {
                crcl = crcl * 0.85;
            }
            
            // 3. คำนวณ eGFR ตามสูตร CKD-EPI (2009)
            // k: หญิง = 0.7, ชาย = 0.9
            // a: หญิง = -0.329, ชาย = -0.411
            const k = (gender === 'female') ? 0.7 : 0.9;
            const a = (gender === 'female') ? -0.329 : -0.411;
            const genderFactor = (gender === 'female') ? 1.018 : 1;
            
            const ratio = scr / k;
            const egfr = 141 * Math.pow(Math.min(ratio, 1), a) * Math.pow(Math.max(ratio, 1), -1.209) * Math.pow(0.993, age) * genderFactor;

            // 4. แสดงผลลัพธ์
            const crclFormatted = Math.round(crcl);
            const egfrFormatted = Math.round(egfr);
            
            document.getElementById('crclValue').innerText = crclFormatted;
            document.getElementById('egfrValue').innerText = egfrFormatted;

            // แสดง/ซ่อน กล่องแจ้งเตือน Obesity
            const warningBox = document.getElementById('obesityWarning');
            if (isObese) {
                document.getElementById('bmiValueDisplay').innerText = bmi.toFixed(1);
                document.getElementById('adjBwValue').innerText = adjBW.toFixed(1);
                warningBox.classList.remove('hidden');
            } else {
                warningBox.classList.add('hidden');
            }

            // 5. แปลผล (Interpretation) - ใช้ eGFR ในการประเมิน Stage โรคไตจะแม่นยำกว่า
            interpretResult(egfrFormatted);

            // เปิดแสดงส่วนผลลัพธ์
            const resultSection = document.getElementById('resultSection');
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function interpretResult(value) {
            const badge = document.getElementById('interpretationBadge');
            const text = document.getElementById('interpretationText');
            
            let stageClass = "";
            let stageLabel = "";
            let stageDesc = "";

            if (value >= 90) {
                stageClass = "bg-green-100 text-green-800";
                stageLabel = "การทำงานของไตปกติ (Stage 1)";
                stageDesc = "ค่าการกรองของไตอยู่ในเกณฑ์ปกติ";
            } else if (value >= 60) {
                stageClass = "bg-yellow-100 text-yellow-800";
                stageLabel = "ไตเสื่อมเล็กน้อย (Stage 2)";
                stageDesc = "ควรติดตามค่าไตเป็นระยะ";
            } else if (value >= 30) {
                stageClass = "bg-orange-100 text-orange-800";
                stageLabel = "ไตเสื่อมปานกลาง (Stage 3)";
                stageDesc = "ควรปรึกษาแพทย์เพื่อปรับพฤติกรรมหรือยา";
            } else if (value >= 15) {
                stageClass = "bg-red-100 text-red-800";
                stageLabel = "ไตเสื่อมมาก (Stage 4)";
                stageDesc = "มีความเสี่ยงสูง ต้องได้รับการดูแลใกล้ชิด";
            } else {
                stageClass = "bg-red-200 text-red-900 border border-red-300";
                stageLabel = "ไตวายระยะสุดท้าย (Stage 5)";
                stageDesc = "เข้าสู่ภาวะไตวาย จำเป็นต้องได้รับการรักษาทดแทนไต";
            }

            badge.className = `inline-block px-3 py-1 text-sm font-semibold rounded-full ${stageClass}`;
            badge.innerText = stageLabel;
            text.innerText = stageDesc;
        }

        function resetForm() {
            document.getElementById('crclForm').reset();
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('obesityWarning').classList.add('hidden');
        }
    </script>
</body>
</html>
